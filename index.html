<!DOCTYPE html>
<html>
  <head>
    <title>laterti.me prototype</title>
    <style>
      #topframe {
        position: relative;
      }
      #overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
      }
    </style>
  </head>
  <body>
    <div id="topframe">
      <div id="overlay"></div>
      <video controls id="video">
        <source id="mp4" src="http://media.w3.org/2010/05/sintel/trailer.mp4" type="video/mp4">
      </video>
    </div>
    <div id="input">
      <input id="msg-entry" type="text">
    </div>
    <div id="comments"></div>
    
    <script>
        var messages = [
        {
          time: 6,
          body: "wow",
          user: "sinahab",
          date: 1400365286166
        },
        {
          time: 8,
          body: "such mountain",
          user: "sinahab",
          date: 1400365328554
        },
        {
          body: 'many dagron',
          time: 26,
          date: 1400365176182,
          user: 'stuartpb'
        },
      ];
    </script>
    <script>
      /* global messages
    */
      var vidframe = document.getElementById('video');
      var comments = document.getElementById('comments');
      var msgEntry = document.getElementById('msg-entry');
      var displayedCom = [];
      var loggedInUser = "stuartpb";
      var secTime = 0;

      msgEntry.addEventListener('keypress', function(evt){
        if (evt.keyCode == 10 || evt.keyCode == 13) {
          var body = msgEntry.value;
          ltInsertMessage({
            user: loggedInUser,
            body: body,
            time: vidframe.currentTime,
            date: Date.now()
          });
          msgEntry.value = "";
        }
      });

      function ltInsertMessage(msg) {
        var i = 0;
        while (i<messages.length && messages[i].time < msg.time) {
          i++;
        }
        messages.splice(i, 0, msg);
        if (msg.time <= vidframe.currentTime) {
          var comment = ltCreateComment(msg);
          if (i > 0) {
            comments.insertBefore(comment, displayedCom[i-1]);
          } else {
            comments.appendChild(comment);
          }
          displayedCom.push(comment);
        }
      }

      function ltUpdateTime(time) {
        secTime = time;
        while(displayedCom.length < messages.length && messages[displayedCom.length].time <= secTime){
          var msg = ltCreateComment(messages[displayedCom.length]);
          displayedCom.push(msg);
          comments.insertBefore(msg, comments.firstChild);
        }
        while(displayedCom.length>0 && messages[displayedCom.length-1].time > secTime){
          comments.removeChild(displayedCom.pop());
        }
      }

      vidframe.addEventListener('timeupdate',function(evt){
        ltUpdateTime(vidframe.currentTime);
      });

      function ltCreateComment(msg){
          var comment = document.createElement('div');
          comment.className = 'comment';
          
          var comUser = document.createElement('span');
          comUser.className = 'com-user';
          comUser.textContent = msg.user;
          
          var comTime = document.createElement('span');
          comTime.className = 'com-time';
          comTime.textContent = msg.time;
          
          var comBody = document.createElement('span');
          comBody.className = 'com-body';
          comBody.textContent = msg.body;
          
          comment.appendChild(comUser);
          comment.appendChild(comTime);
          comment.appendChild(comBody);
          
          return comment;
      }
      
    </script>
  </body>
</html>